# Proposal for Software Bill-of-Materials for CPython

<blockquote>
  <center>This critical role would not be possible without funding from the OpenSSF <a href="https://alpha-omega.dev">Alpha-Omega project</a>. Massive thank-you to Alpha-Omega for investing in the security of the Python ecosystem!</center>
</blockquote>

This week I created the [top-level tracking GitHub issue](https://github.com/python/cpython/issues/112302) for being able to create and distribute Software Bill-of-Materials
documents alongside Python artifacts on [python.org/downloads](https://python.org/downloads). To completely implement SBOMs
for CPython it will require changes to multiple repositories ([`cpython`](https://github.com/python/cpython), [`release-tools`](https://github.com/python/release-tools), [`cpython-source-deps`](https://github.com/python/cpython-source-deps), [`pythondotorg`](https://github.com/python/pythondotorg), ...) so this issue
will be the central tracking location.

I've also [created a PR](https://github.com/python/cpython/pull/112303) which adapts [my experiments in creating SBOMs](https://github.com/sethmlarson/cpython-sbom) for past and current CPython releases
and trying those SBOMs with current scanners. The PR adds a new
Makefile target `regen-sbom` which updates the dependencies-only SBOM in the CPython codebase.

This proposal doesn't modify Python itself but does have some implications for Python core developers due to needing to
update SBOM metadata whenever vendored dependencies are upgraded (including those in [cpython-source-deps](https://github.com/python/cpython-source-deps)) to ensure the
data is consistent. The method I've proposed uses SBOM file checksums to check whether a file has been updated and if so, to flag to the author of the PR that they need
to update SBOM metadata.

<p>
<center>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="501px" viewBox="-0.5 -0.5 501 401" style="max-width:100%;max-height:401px;"><defs/><g><rect x="0" y="140" width="120" height="120" fill="#f5f5f5" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)rotate(-90 7 200)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 200px; margin-left: -52px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: #333; "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(51, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">advisory-db</div></div></div></foreignObject><text x="7" y="212" fill="#333" font-family="monospace" font-size="12px" text-anchor="middle">advisory-db</text></switch></g><rect x="140" y="0" width="120" height="120" fill="#f5f5f5" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)rotate(-90 147 60)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 60px; margin-left: 88px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: #333; "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(51, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">cpython</div></div></div></foreignObject><text x="147" y="72" fill="#333" font-family="monospace" font-size="12px" text-anchor="middle">cpython</text></switch></g><rect x="260" y="0" width="120" height="120" fill="#f5f5f5" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)rotate(-90 267 60)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 60px; margin-left: 208px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: #333; "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(51, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">source-deps</div></div></div></foreignObject><text x="267" y="72" fill="#333" font-family="monospace" font-size="12px" text-anchor="middle">source-deps</text></switch></g><rect x="140" y="140" width="360" height="120" fill="#f5f5f5" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)rotate(-90 147 200)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 200px; margin-left: 88px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: #333; "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(51, 51, 51); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">release-tools</div></div></div></foreignObject><text x="147" y="212" fill="#333" font-family="monospace" font-size="12px" text-anchor="middle">release-tools</text></switch></g><path d="M 210 100 L 210 130 L 310 130 L 310 153.63" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 310 158.88 L 306.5 151.88 L 310 153.63 L 313.5 151.88 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><path d="M 210 100 L 210 153.63" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 210 158.88 L 206.5 151.88 L 210 153.63 L 213.5 151.88 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><path d="M 210 100 L 210 130 L 450 130 L 450 153.63" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 450 158.88 L 446.5 151.88 L 450 153.63 L 453.5 151.88 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="170" y="20" width="80" height="80" fill="#dae8fc" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 60px; margin-left: 171px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython Base SBOM</div></div></div></foreignObject><text x="210" y="64" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython Base...</text></switch></g><path d="M 190 240 L 190 280 L 90 280 L 90 246.37" fill="none" stroke="#000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="stroke"/><path d="M 90 241.12 L 93.5 248.12 L 90 246.37 L 86.5 248.12 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><path d="M 230 240 L 230 340 L 176.37 340" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 171.12 340 L 178.12 336.5 L 176.37 340 L 178.12 343.5 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="170" y="160" width="80" height="80" fill="#d5e8d4" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 200px; margin-left: 171px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython Source SBOM</div></div></div></foreignObject><text x="210" y="204" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython Sourc...</text></switch></g><path d="M 310 240 L 310 280 L 90 280 L 90 246.37" fill="none" stroke="#000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="stroke"/><path d="M 90 241.12 L 93.5 248.12 L 90 246.37 L 86.5 248.12 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><path d="M 350 240 L 350 360 L 176.37 360" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 171.12 360 L 178.12 356.5 L 176.37 360 L 178.12 363.5 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="290" y="160" width="80" height="80" fill="#d5e8d4" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 200px; margin-left: 291px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython Windows SBOM</div></div></div></foreignObject><text x="330" y="204" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython Windo...</text></switch></g><path d="M 430 240 L 430 280 L 90 280 L 90 246.37" fill="none" stroke="#000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="stroke"/><path d="M 90 241.12 L 93.5 248.12 L 90 246.37 L 86.5 248.12 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><path d="M 470 240 L 470 380 L 176.37 380" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 171.12 380 L 178.12 376.5 L 176.37 380 L 178.12 383.5 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="410" y="160" width="80" height="80" fill="#d5e8d4" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 200px; margin-left: 411px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython macOS SBOM</div></div></div></foreignObject><text x="450" y="204" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython macOS...</text></switch></g><path d="M 70 240 L 70 360 L 83.63 360" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 88.88 360 L 81.88 363.5 L 83.63 360 L 81.88 356.5 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="30" y="160" width="80" height="80" fill="#dae8fc" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 200px; margin-left: 31px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython VEX Statements</div></div></div></foreignObject><text x="70" y="204" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython VEX S...</text></switch></g><path d="M 350 100 L 350 153.63" fill="none" stroke="#000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 350 158.88 L 346.5 151.88 L 350 153.63 L 353.5 151.88 Z" fill="#000" stroke="#000" stroke-miterlimit="10" pointer-events="all"/><rect x="290" y="20" width="80" height="80" fill="#dae8fc" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 60px; margin-left: 291px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">CPython Source Deps SBOMs</div></div></div></foreignObject><text x="330" y="64" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">CPython Sourc...</text></switch></g><rect x="90" y="320" width="80" height="80" fill="#ffe6cc" stroke="#000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 360px; margin-left: 91px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">Vuln Scanner</div></div></div></foreignObject><text x="130" y="364" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">Vuln Scanner</text></switch></g><rect x="90" y="280" width="100" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 98px; height: 1px; padding-top: 290px; margin-left: 91px;"><div style="box-sizing: border-box; font-size: 0px; text-align: center;" data-drawio-colors="color: rgb(0, 0, 0); "><div style="display: inline-block; font-size: 12px; font-family: monospace; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><font face="monospace">External Ref<br /></font></div></div></div></foreignObject><text x="140" y="294" fill="rgb(0, 0, 0)" font-family="monospace" font-size="12px" text-anchor="middle">External Ref&#xa;</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>
</center>
</p>

Above is the architecture diagram for how the final released SBOMs will be created. The blue elements above denote metadata that would need to be manually updated and green elements (within the `release-tools` area) would be
generated as a result of automation using the base CPython SBOM and source deps SBOMs as starting points. The green SBOM elements would be published to [python.org/downloads](https://python.org/downloads).

This proposal is also likely to carry additional maintenance burden, especially for Python Security Response Team and Release Manager members. Having more visibility into the
software that users are running combined with vulnerability scanners means there will be more folks knocking on the door whenever a vulnerability in one of our
dependencies is published.

I am hoping that there is a systematic way of reducing this effort especially when it comes to vulnerabilities in subcomponents which
*aren't exploitable* (which is common for OpenSSL, which we only use TLS). My current approach is to embed a link (marked as `External Ref` above) to [Vulnerability Exploitability Exchange](https://cyclonedx.org/capabilities/vex/) (VEX) statements that can be controlled by core developers. I'm currently researching this
for both SBOM formats and scanners.

Because of this additional burden to core developers and to field questions I have [opened a Discourse topic](https://discuss.python.org/t/create-and-distribute-software-bill-of-materials-sbom-for-python-artifacts/39293) for this work. Please leave a comment or question and I will reply!

## Memory safety hardening through compiler options

The [OpenSSF Best Practices working group](https://github.com/ossf/wg-best-practices-os-developers/) recently completed a [C and C++ hardening guide](https://github.com/ossf/wg-best-practices-os-developers/blob/main/docs/Compiler-Hardening-Guides/Compiler-Options-Hardening-Guide-for-C-and-C%2B%2B.md) using compiler options.
**Michael Droettboom** and I were invited to discuss this new guide and Python. I mentioned it'd be interesting
to see what the current CPython build would produce with all the options enabled and Michael was successfully sniped 😉.
Michael helpfully [created an issue](https://github.com/python/cpython/issues/112301) with the [complete build log and all the warnings](https://gist.github.com/mdboom/1f898fd2cd479e8af49403d510b22c34).
The build was able to complete successfully along with passing all test cases.

The options currently being considered are:

```shell
-O2 -Wall -Wformat=2 -Wconversion -Wtrampolines -Wimplicit-fallthrough \
-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=3 \
-D_GLIBCXX_ASSERTIONS \
-fstrict-flex-arrays=3 \
-fstack-clash-protection -fstack-protector-strong \
-Wl,-z,nodlopen -Wl,-z,noexecstack \
-Wl,-z,relro -Wl,-z,now \
-fPIE -pie -fPIC
```

We'll likely be picking through each option and adopting the ones that make sense for CPython.
There was [already a PR created](https://github.com/python/cpython/pull/112308) to fix the single issue found by `-Wmaybe-uninitialized`.

The guide itself has a [section going into the behavior and requirements of each option](https://github.com/ossf/wg-best-practices-os-developers/blob/main/docs/Compiler-Hardening-Guides/Compiler-Options-Hardening-Guide-for-C-and-C%2B%2B.md#recommended-compiler-options).

## Other items

* My work was [featured in an article](https://thenewstack.io/pythons-new-security-developer-has-plans-to-secure-the-language/) by The New Stack.
* I [became a Python triager](https://github.com/python/core-workflow/issues/515) thanks to the recommendation by **Hugo van Kemenade** in order to be on the `CODEOWNERS` list for CPython SBOM tooling and resources. 
* [Submitted PR](https://github.com/python/release-tools/pull/71/files) to move CPython's source and documentation builds to GitHub Actions.
  I'm waiting for the Developer-in-Residence **Łukasz Langa** to return from conferences to land this one.
* Submitted [multiple PRs](https://github.com/python/cpython/issues/112160) to CPython to pin the `cpython_autoconf` container to its SHA256 manifest.
  This container is used to ensure `autoconf` is consistent across all contributors. I plan to use
  `make regen-configure` as a [part of the CPython release process](https://github.com/python/cpython/pull/112090#issuecomment-1813337104).
* The [Python Package Index had the results of its first audit published](https://blog.pypi.org/posts/2023-11-14-1-pypi-completes-first-security-audit/), and they came back quite positively ([no high or critical severity issues identified for PyPI](https://blog.pypi.org/posts/2023-11-14-2-security-audit-remediation-warehouse/))
  Thanks to the [Open Tech Fund](https://www.opentech.fund/) for funding this and [Trail of Bits](https://www.trailofbits.com/) for performing the audit!

Thursday and Friday are holidays in the United States and from Monday to Thursday I'll be traveling to meet up with some of my colleagues at the Python Software Foundation.
Due to this, expect there to not be much to report for next week. See you in December!

That's all for this week! 👋 If you're interested in more you can read [next week's report](https://sethmlarson.dev/security-developer-in-residence-weekly-report-20) or [last week's report](https://sethmlarson.dev/security-developer-in-residence-weekly-report-18).
